local Library = loadstring(game:HttpGet("https://api.junkie-development.de/api/v1/luascripts/public/eb7222cf54839e8674e21eab83982947e49f0fa4f7b3f30e8f79f8d95de72390/download"))()

local Window = Library:Window({
    Name = "Nevox BBR",
    SubName = "by Madness idk",
    Logo = "120959262762131"
})

-- Main tabs with icons
Window:Category("Main Features")
local MainPage = Window:Page({Name = "Main", Icon = "134236649319095"})
local CombatPage = Window:Page({Name = "Combat", Icon = "100050851789190"})
local MapPage = Window:Page({Name = "Map", Icon = "123944728972740"})
local PickupPage = Window:Page({Name = "Pickup", Icon = "108839695397679"})
local FarmingPage = Window:Page({Name = "Farming", Icon = "123554105934637"})

Window:Category("Visual")
local ESPPage = Window:Page({Name = "ESP", Icon = "138827881557940", Columns = 1})

Window:Category("Settings")
local SettingsPage = Library:CreateSettingsPage(Window)

-- Services
local rs = game:GetService("ReplicatedStorage")
local packets
local success, err = pcall(function()
    packets = require(rs.Modules.Packets)
end)
if not success then
    Library:Notification({
        Title = "Warning",
        Description = "Failed to load packets module: " .. tostring(err),
        Duration = 5,
        Icon = "73789337996373"
    })
end

local plr = game.Players.LocalPlayer
local char = plr.Character or plr.CharacterAdded:Wait()
local root = char:WaitForChild("HumanoidRootPart")
local hum = char:WaitForChild("Humanoid")
local runs = game:GetService("RunService")
local uis = game:GetService("UserInputService")
local tspmo = game:GetService("TweenService")

-- Variables
local originalValues = {
    WalkSpeed = hum.WalkSpeed,
    JumpPower = hum.JumpPower,
    HipHeight = hum.HipHeight,
    MaxSlopeAngle = hum.MaxSlopeAngle
}

-- ESP Variables
local espEnabled = false
local espShowHP = true
local espShowArmor = true
local espShowWeapon = true
local espMaxDistance = 2500

-- Auto Heal Variables
local lastEatTime = 0
local autoHealEnabled = false
local autoEatEnabled = false
local autoHealFruit = "Bloodfruit"
local autoEatFruit = "Coconut"
local autoHealThreshold = 90
local autoEatThreshold = 90
local autoEatCPS = 1  -- Fixed to 1 instead of NaN

-- Combat Variables
local killAuraEnabled = false
local killAuraRange = 30
local kaTargetCount = 1
local kaSwingCooldown = 0.1

-- Resource Aura Variables
local resourceAuraEnabled = false
local resourceAuraRange = 20
local resourceTargetCount = 1
local resourceCooldown = 0.1

-- Critter Aura Variables
local critterAuraEnabled = false
local critterRange = 20
local critterTargetCount = 1
local critterCooldown = 0.1

-- Pickup Variables
local autoPickupEnabled = false
local chestPickupEnabled = false
local pickupRange = 20
local selectedItems = {"Leaves", "Log"}
local autoDropEnabled = false
local autoDropCustomEnabled = false
local dropItem = "Bloodfruit"
local customDropItem = "Bloodfruit"
local customPickupText = ""
local customPickupEnabled = false

-- Farming Variables
local plantToggle = false
local plantRange = 30
local plantDelay = 0.1
local harvestToggle = false
local harvestRange = 30
local selectedFruit = "Bloodfruit"
local tweenToPlantBox = false
local tweenToBush = false
local tweenRange = 250

-- Double Jump Variables
local canDoubleJump = false
local hasDoubleJumped = false
local doubleJumpConnections = {}
local doubleJumpEnabled = false

-- Fruit to Item ID mapping
local fruitToItemId = {
    Bloodfruit = 94,
    Bluefruit = 377,
    Lemon = 99,
    Coconut = 1,
    Jelly = 604,
    Banana = 606,
    Orange = 602,
    Oddberry = 32,
    Berry = 35,
    Strangefruit = 302,
    Strawberry = 282,
    Sunfruit = 128,
    Pumpkin = 80,
    ["Prickly Pear"] = 378,
    Apple = 243,
    Barley = 247,
    Cloudberry = 101,
    Carrot = 147
}

-- All items for pickups
local allItems = {
    "Berry", "Bloodfruit", "Bluefruit", "Lemon", "Strawberry", "Gold", 
    "Raw Gold", "Crystal Chunk", "Coin", "Coins", "Coin2", "Coin Stack", 
    "Essence", "Emerald", "Raw Emerald", "Pink Diamond", "Raw Pink Diamond", 
    "Void Shard", "Jelly", "Magnetite", "Raw Magnetite", "Adurite", 
    "Raw Adurite", "Ice Cube", "Stone", "Iron", "Raw Iron", "Steel", 
    "Hide", "Leaves", "Log", "Wood", "Pie"
}

-- All items for dropping
local allDropItems = {
    "Bloodfruit", "Jelly", "Bluefruit", "Log", "Leaves", "Wood"
}

-- =================== MAIN TAB ===================
local MainSection = MainPage:Section({Name = "Player Stats", Description = "Modify your player stats", Side = 1})

local wstoggle = MainSection:Toggle({
    Name = "Walkspeed",
    Flag = "WalkSpeedToggle",
    Default = false,
    Callback = function(Value)
        updateWalkspeed(Value)
    end
})

local wsslider = MainSection:Slider({
    Name = "Walkspeed Value",
    Flag = "WalkSpeedValue",
    Min = 10,
    Max = 100,
    Suffix = "studs",
    Default = 16,
    Decimals = 1,
    Callback = function(Value)
        if wstoggle:Get() then
            hum.WalkSpeed = Value
        end
    end
})

local jptoggle = MainSection:Toggle({
    Name = "JumpPower",
    Flag = "JumpPowerToggle",
    Default = false,
    Callback = function(Value)
        updateJumpPower(Value)
    end
})

local jpslider = MainSection:Slider({
    Name = "JumpPower Value",
    Flag = "JumpPowerValue",
    Min = 30,
    Max = 150,
    Suffix = "power",
    Default = 50,
    Decimals = 1,
    Callback = function(Value)
        if jptoggle:Get() then
            hum.JumpPower = Value
        end
    end
})

local hheighttoggle = MainSection:Toggle({
    Name = "HipHeight",
    Flag = "HipHeightToggle",
    Default = false,
    Callback = function(Value)
        updateHipHeight(Value)
    end
})

local hheightslider = MainSection:Slider({
    Name = "HipHeight Value",
    Flag = "HipHeightValue",
    Min = 0.1,
    Max = 15,
    Suffix = "studs",
    Default = 2,
    Decimals = 1,
    Callback = function(Value)
        if hheighttoggle:Get() then
            hum.HipHeight = Value
        end
    end
})

local msatoggle = MainSection:Toggle({
    Name = "No Mountain Slip",
    Flag = "NoSlipToggle",
    Default = false,
    Callback = function(Value)
        updateNoSlip(Value)
    end
})

local doublejumptoggle = MainSection:Toggle({
    Name = "Double Jump",
    Flag = "DoubleJumpToggle",
    Default = false,
    Callback = function(Value)
        updateDoubleJump(Value)
    end
})

local UtilitySection = MainPage:Section({Name = "Utilities", Description = "Utility features", Side = 2})

UtilitySection:Button({
    Name = "Reset Character",
    Callback = function()
        if char then
            char:BreakJoints()
            Library:Notification({
                Title = "Reset",
                Description = "Character reset!",
                Duration = 3,
                Icon = "73789337996373"
            })
        end
    end
})

-- =================== COMBAT TAB (with Auto Heal) ===================
local CombatSection = CombatPage:Section({Name = "Kill Aura", Description = "Auto attack players", Side = 1})

local killauratoggle = CombatSection:Toggle({
    Name = "Kill Aura",
    Flag = "KillAuraToggle",
    Default = false,
    Callback = function(Value)
        killAuraEnabled = Value
    end
})

local killaurarangeslider = CombatSection:Slider({
    Name = "Range",
    Flag = "KillAuraRange",
    Min = 1,
    Max = 50,
    Suffix = "studs",
    Default = 30,
    Decimals = 1,
    Callback = function(Value)
        killAuraRange = Value
    end
})

local katargetcountdropdown = CombatSection:Dropdown({
    Name = "Max Targets",
    Flag = "KATargetCount",
    Default = "1",
    Items = {"1", "2", "3", "4", "5", "6"},
    Multi = false,
    Callback = function(Value)
        kaTargetCount = tonumber(Value)
    end
})

local kaswingcooldownslider = CombatSection:Slider({
    Name = "Attack Cooldown (s)",
    Flag = "KASwingCooldown",
    Min = 0.01,
    Max = 1.01,
    Suffix = "s",
    Default = 0.1,
    Decimals = 2,
    Callback = function(Value)
        kaSwingCooldown = Value
    end
})

local AutoHealSection = CombatPage:Section({Name = "Auto Heal", Description = "Automatic healing and eating", Side = 2})

local autohealtoggle = AutoHealSection:Toggle({
    Name = "Auto Heal",
    Flag = "AutoHealToggle",
    Default = false,
    Callback = function(Value)
        autoHealEnabled = Value
    end
})

local heal_fruitdropdown = AutoHealSection:Dropdown({
    Name = "Fruit for Auto Heal",
    Flag = "HealFruit",
    Default = "Bloodfruit",
    Items = {"Bloodfruit", "Bluefruit", "Lemon", "Coconut", "Jelly", "Banana", "Orange", "Oddberry", "Berry", "Strangefruit", "Strawberry", "Sunfruit", "Pumpkin", "Prickly Pear", "Apple", "Barley", "Cloudberry", "Carrot"},
    Multi = false,
    Callback = function(Value)
        autoHealFruit = Value
    end
})

local autohealslider = AutoHealSection:Slider({
    Name = "Heal Below %",
    Flag = "HealThreshold",
    Min = 1,
    Max = 100,
    Suffix = "%",
    Default = 90,
    Decimals = 1,
    Callback = function(Value)
        autoHealThreshold = Value
    end
})

local autoeattoggle = AutoHealSection:Toggle({
    Name = "Auto Eat",
    Flag = "AutoEatToggle",
    Default = false,
    Callback = function(Value)
        autoEatEnabled = Value
    end
})

local eat_fruitdropdown = AutoHealSection:Dropdown({
    Name = "Fruit for Auto Eat",
    Flag = "EatFruit",
    Default = "Coconut",
    Items = {"Bloodfruit", "Bluefruit", "Lemon", "Coconut", "Jelly", "Banana", "Orange", "Oddberry", "Berry", "Strangefruit", "Strawberry", "Sunfruit", "Pumpkin", "Prickly Pear", "Apple", "Barley", "Cloudberry", "Carrot"},
    Multi = false,
    Callback = function(Value)
        autoEatFruit = Value
    end
})

local autoeatslider = AutoHealSection:Slider({
    Name = "Eat Below %",
    Flag = "EatThreshold",
    Min = 1,
    Max = 100,
    Suffix = "%",
    Default = 90,
    Decimals = 1,
    Callback = function(Value)
        autoEatThreshold = Value
    end
})

local autoeatcps = AutoHealSection:Slider({
    Name = "Eat Speed (CPS)",
    Flag = "EatCPS",
    Min = 1,
    Max = 120,
    Suffix = "cps",
    Default = 1,
    Decimals = 0,
    Callback = function(Value)
        autoEatCPS = Value
    end
})

-- =================== MAP TAB ===================
local ResourceSection = MapPage:Section({Name = "Resource Aura", Description = "Auto farm resources", Side = 1})

local resourceauratoggle = ResourceSection:Toggle({
    Name = "Resource Aura",
    Flag = "ResourceAuraToggle",
    Default = false,
    Callback = function(Value)
        resourceAuraEnabled = Value
    end
})

local resourceaurarange = ResourceSection:Slider({
    Name = "Range",
    Flag = "ResourceAuraRange",
    Min = 1,
    Max = 50,
    Suffix = "studs",
    Default = 20,
    Decimals = 1,
    Callback = function(Value)
        resourceAuraRange = Value
    end
})

local resourcetargetdropdown = ResourceSection:Dropdown({
    Name = "Max Targets",
    Flag = "ResourceTargetCount",
    Default = "1",
    Items = {"1", "2", "3", "4", "5", "6"},
    Multi = false,
    Callback = function(Value)
        resourceTargetCount = tonumber(Value)
    end
})

local resourcecooldownslider = ResourceSection:Slider({
    Name = "Swing Cooldown (s)",
    Flag = "ResourceCooldown",
    Min = 0.01,
    Max = 1.01,
    Suffix = "s",
    Default = 0.1,
    Decimals = 2,
    Callback = function(Value)
        resourceCooldown = Value
    end
})

local CritterSection = MapPage:Section({Name = "Critter Aura", Description = "Auto farm critters", Side = 2})

local critterauratoggle = CritterSection:Toggle({
    Name = "Critter Aura",
    Flag = "CritterAuraToggle",
    Default = false,
    Callback = function(Value)
        critterAuraEnabled = Value
    end
})

local critterrangeslider = CritterSection:Slider({
    Name = "Range",
    Flag = "CritterRange",
    Min = 1,
    Max = 50,
    Suffix = "studs",
    Default = 20,
    Decimals = 1,
    Callback = function(Value)
        critterRange = Value
    end
})

local crittertargetdropdown = CritterSection:Dropdown({
    Name = "Max Targets",
    Flag = "CritterTargetCount",
    Default = "1",
    Items = {"1", "2", "3", "4", "5", "6"},
    Multi = false,
    Callback = function(Value)
        critterTargetCount = tonumber(Value)
    end
})

local crittercooldownslider = CritterSection:Slider({
    Name = "Swing Cooldown (s)",
    Flag = "CritterCooldown",
    Min = 0.01,
    Max = 1.01,
    Suffix = "s",
    Default = 0.1,
    Decimals = 2,
    Callback = function(Value)
        critterCooldown = Value
    end
})

-- =================== PICKUP TAB ===================
local PickupSection = PickupPage:Section({Name = "Auto Pickup", Description = "Auto collect items", Side = 1})

local autopickuptoggle = PickupSection:Toggle({
    Name = "Auto Pickup",
    Flag = "AutoPickupToggle",
    Default = false,
    Callback = function(Value)
        autoPickupEnabled = Value
    end
})

local chestpickuptoggle = PickupSection:Toggle({
    Name = "Auto Pickup From Chests",
    Flag = "ChestPickupToggle",
    Default = false,
    Callback = function(Value)
        chestPickupEnabled = Value
    end
})

local pickuprangeslider = PickupSection:Slider({
    Name = "Pickup Range",
    Flag = "PickupRange",
    Min = 1,
    Max = 50,
    Suffix = "studs",
    Default = 20,
    Decimals = 1,
    Callback = function(Value)
        pickupRange = Value
    end
})

-- Create the dropdown with All option - SIMPLIFIED VERSION
local dropdownItems = {}
for _, item in ipairs(allItems) do
    table.insert(dropdownItems, item)
end
table.insert(dropdownItems, "All")

-- Store dropdown values in a table
local dropdownValues = {}

local itemdropdown = PickupSection:Dropdown({
    Name = "Items to Pickup",
    Flag = "ItemDropdown",
    Default = {"Leaves", "Log"},
    Items = dropdownItems,
    Multi = true,
    Callback = function(Value)
        dropdownValues = Value
        selectedItems = {}
        
        -- If "All" is selected, add all items
        if Value["All"] then
            for _, item in ipairs(allItems) do
                table.insert(selectedItems, item)
            end
        else
            -- Add only selected individual items
            for item, isSelected in pairs(Value) do
                if isSelected and item ~= "All" then
                    table.insert(selectedItems, item)
                end
            end
        end
    end
})

local custompickuptoggle = PickupSection:Toggle({
    Name = "Custom Item Pickup",
    Flag = "CustomPickupToggle",
    Default = false,
    Callback = function(Value)
        customPickupEnabled = Value
    end
})

local custompickuptextbox = PickupSection:Textbox({
    Name = "Custom Item Name",
    Flag = "CustomPickupTextbox",
    Default = "",
    Numeric = false,
    Placeholder = "Enter item name...",
    Finished = true,
    Callback = function(Value)
        customPickupText = Value
    end
})

local DropSection = PickupPage:Section({Name = "Auto Drop", Description = "Auto drop items", Side = 2})

local droptoggle = DropSection:Toggle({
    Name = "Auto Drop",
    Flag = "AutoDropToggle",
    Default = false,
    Callback = function(Value)
        autoDropEnabled = Value
    end
})

-- Create drop dropdown with All option
local dropDropdownItems = {}
for _, item in ipairs(allDropItems) do
    table.insert(dropDropdownItems, item)
end
table.insert(dropDropdownItems, "All")

local dropdropdown = DropSection:Dropdown({
    Name = "Select Item to Drop",
    Flag = "DropDropdown",
    Default = "Bloodfruit",
    Items = dropDropdownItems,
    Multi = false,
    Callback = function(Value)
        dropItem = Value
    end
})

local droptogglemanual = DropSection:Toggle({
    Name = "Auto Drop Custom",
    Flag = "AutoDropCustomToggle",
    Default = false,
    Callback = function(Value)
        autoDropCustomEnabled = Value
    end
})

local droptextbox = DropSection:Textbox({
    Name = "Custom Item",
    Flag = "DropTextbox",
    Default = "Bloodfruit",
    Numeric = false,
    Placeholder = "...",
    Finished = true,
    Callback = function(Value)
        customDropItem = Value
    end
})

-- =================== FARMING TAB ===================
local FarmingSection = FarmingPage:Section({Name = "Auto Farming", Description = "Auto plant and harvest", Side = 1})

local fruitdropdown = FarmingSection:Dropdown({
    Name = "Select Fruit",
    Flag = "FruitDropdown",
    Default = "Bloodfruit",
    Items = {"Bloodfruit", "Bluefruit", "Lemon", "Coconut", "Jelly", "Banana", "Orange", "Oddberry", "Berry", "Strangefruit", "Strawberry", "Sunfruit", "Pumpkin", "Prickly Pear", "Apple", "Barley", "Cloudberry", "Carrot"},
    Multi = false,
    Callback = function(Value)
        selectedFruit = Value
    end
})

local planttoggle = FarmingSection:Toggle({
    Name = "Auto Plant",
    Flag = "PlantToggle",
    Default = false,
    Callback = function(Value)
        plantToggle = Value
    end
})

local plantrangeslider = FarmingSection:Slider({
    Name = "Plant Range",
    Flag = "PlantRange",
    Min = 1,
    Max = 100,
    Suffix = "studs",
    Default = 30,
    Decimals = 1,
    Callback = function(Value)
        plantRange = Value
    end
})

local plantdelayslider = FarmingSection:Slider({
    Name = "Plant Delay (s)",
    Flag = "PlantDelay",
    Min = 0.01,
    Max = 1,
    Suffix = "s",
    Default = 0.1,
    Decimals = 2,
    Callback = function(Value)
        plantDelay = Value
    end
})

local harvesttoggle = FarmingSection:Toggle({
    Name = "Auto Harvest",
    Flag = "HarvestToggle",
    Default = false,
    Callback = function(Value)
        harvestToggle = Value
    end
})

local harvestrangeslider = FarmingSection:Slider({
    Name = "Harvest Range",
    Flag = "HarvestRange",
    Min = 1,
    Max = 100,
    Suffix = "studs",
    Default = 30,
    Decimals = 1,
    Callback = function(Value)
        harvestRange = Value
    end
})

local TweenSection = FarmingPage:Section({Name = "Tween Farming", Description = "Teleport farming", Side = 2})

local tweenplantboxtoggle = TweenSection:Toggle({
    Name = "Tween to Plant Box",
    Flag = "TweenPlantBoxToggle",
    Default = false,
    Callback = function(Value)
        tweenToPlantBox = Value
        if Value and tweenToBush then
            tweenbushtoggle:Set(false)
        end
    end
})

local tweenbushtoggle = TweenSection:Toggle({
    Name = "Tween to Bush + Plant Box",
    Flag = "TweenBushToggle",
    Default = false,
    Callback = function(Value)
        tweenToBush = Value
        if Value and tweenToPlantBox then
            tweenplantboxtoggle:Set(false)
        end
    end
})

local tweenrangeslider = TweenSection:Slider({
    Name = "Range",
    Flag = "TweenRange",
    Min = 1,
    Max = 500,
    Suffix = "studs",
    Default = 250,
    Decimals = 1,
    Callback = function(Value)
        tweenRange = Value
    end
})

-- =================== ESP TAB ===================
local ESPSection = ESPPage:Section({Name = "ESP Settings", Description = "Player ESP Configuration", Side = 1})

local esptoggle = ESPSection:Toggle({
    Name = "Enable ESP",
    Flag = "ESPToggle",
    Default = false,
    Callback = function(Value)
        espEnabled = Value
        if not Value then
            clearESP()
        else
            createESPForAllPlayers()
        end
    end
})

local esphealth = ESPSection:Toggle({
    Name = "Show HP",
    Flag = "ESPHealth",
    Default = true,
    Callback = function(Value)
        espShowHP = Value
    end
})

local esparmor = ESPSection:Toggle({
    Name = "Show Armor",
    Flag = "ESPArmor",
    Default = true,
    Callback = function(Value)
        espShowArmor = Value
    end
})

local espweapon = ESPSection:Toggle({
    Name = "Show Weapon",
    Flag = "ESPWeapon",
    Default = true,
    Callback = function(Value)
        espShowWeapon = Value
    end
})

local esprange = ESPSection:Slider({
    Name = "Max Distance",
    Flag = "ESPRange",
    Min = 0,
    Max = 5000,
    Suffix = "m",
    Default = 2500,
    Decimals = 1,
    Callback = function(Value)
        espMaxDistance = Value
    end
})

-- =================== SETTINGS TAB ===================
local SettingsSection = SettingsPage:Section({Name = "UI Settings", Description = "Interface settings", Side = 1})

SettingsSection:Toggle({
    Name = "Show Keybinds",
    Flag = "ShowKeybinds",
    Default = true,
    Callback = function(Value)
        if Library.KeybindList then
            Library.KeybindList.Visible = Value
        end
    end
})

-- =================== FUNCTIONS ===================
-- Utility functions
local function tableFind(tab, item)
    for i, v in ipairs(tab) do
        if v == item then
            return i
        end
    end
    return nil
end

local function stringSplit(str, sep)
    local result = {}
    local pattern = string.format("([^%s]+)", sep)
    for match in str:gmatch(pattern) do
        table.insert(result, match)
    end
    return result
end

local function getLayout(itemName)
    local inventory = plr.PlayerGui.MainGui.RightPanel.Inventory:FindFirstChild("List")
    if not inventory then return nil end
    for _, child in ipairs(inventory:GetChildren()) do
        if child:IsA("ImageLabel") and child.Name == itemName then
            return child.LayoutOrder
        end
    end
    return nil
end

local function swingTool(targetIds)
    if packets and packets.SwingTool and packets.SwingTool.send then
        packets.SwingTool.send(targetIds)
    end
end

local function pickup(entityId)
    if packets and packets.Pickup and packets.Pickup.send then
        packets.Pickup.send(entityId)
    end
end

local function drop(itemName)
    local inventory = plr.PlayerGui.MainGui.RightPanel.Inventory:FindFirstChild("List")
    if not inventory then return end
    for _, child in ipairs(inventory:GetChildren()) do
        if child:IsA("ImageLabel") and child.Name == itemName then
            if packets and packets.DropBagItem and packets.DropBagItem.send then
                packets.DropBagItem.send(child.LayoutOrder)
                return true
            end
        end
    end
    return false
end

local function plant(entityId, itemId)
    if packets and packets.InteractStructure and packets.InteractStructure.send then
        packets.InteractStructure.send({ entityID = entityId, itemID = itemId })
    end
end

local function getHealth()
    local success, result = pcall(function()
        local healthLabel = plr.PlayerGui.MainGui.Panels.Stats.Bars.Health.ValueLabel
        if healthLabel and healthLabel.Text then
            local healthText = healthLabel.Text
            local healthValue = tonumber(healthText:match("%d+"))
            return healthValue or 100
        end
    end)
    return success and result or 100
end

local function getHunger()
    local success, result = pcall(function()
        local hungerLabel = plr.PlayerGui.MainGui.Panels.Stats.Bars.Hunger.ValueLabel
        if hungerLabel and hungerLabel.Text then
            local hungerText = hungerLabel.Text
            local hungerValue = tonumber(hungerText:match("%d+"))
            return hungerValue or 100
        end
    end)
    return success and result or 100
end

-- Player stats functions
local walkSpeedConnection, jumpPowerConnection, hipHeightConnection, slopeAngleConnection

function updateWalkspeed(enabled)
    if walkSpeedConnection then
        walkSpeedConnection:Disconnect()
        walkSpeedConnection = nil
    end
    if enabled then
        hum.WalkSpeed = wsslider:Get()
        walkSpeedConnection = runs.RenderStepped:Connect(function()
            if hum and hum.Parent then
                hum.WalkSpeed = wsslider:Get()
            end
        end)
    else
        hum.WalkSpeed = originalValues.WalkSpeed
    end
end

function updateJumpPower(enabled)
    if jumpPowerConnection then
        jumpPowerConnection:Disconnect()
        jumpPowerConnection = nil
    end
    if enabled then
        hum.JumpPower = jpslider:Get()
        jumpPowerConnection = runs.RenderStepped:Connect(function()
            if hum and hum.Parent then
                hum.JumpPower = jpslider:Get()
            end
        end)
    else
        hum.JumpPower = originalValues.JumpPower
    end
end

function updateHipHeight(enabled)
    if hipHeightConnection then
        hipHeightConnection:Disconnect()
        hipHeightConnection = nil
    end
    if enabled then
        hum.HipHeight = hheightslider:Get()
        hipHeightConnection = runs.RenderStepped:Connect(function()
            if hum and hum.Parent then
                hum.HipHeight = hheightslider:Get()
            end
        end)
    else
        hum.HipHeight = originalValues.HipHeight
    end
end

function updateNoSlip(enabled)
    if slopeAngleConnection then
        slopeAngleConnection:Disconnect()
        slopeAngleConnection = nil
    end
    if enabled then
        hum.MaxSlopeAngle = 89.9
        slopeAngleConnection = runs.RenderStepped:Connect(function()
            if hum and hum.Parent then
                hum.MaxSlopeAngle = 89.9
            end
        end)
    else
        hum.MaxSlopeAngle = originalValues.MaxSlopeAngle
    end
end

-- FIXED Double Jump function
function updateDoubleJump(enabled)
    for _, conn in pairs(doubleJumpConnections) do
        conn:Disconnect()
    end
    doubleJumpConnections = {}
    doubleJumpEnabled = enabled
    
    if enabled then
        local connection1 = uis.InputBegan:Connect(function(input, gameProcessed)
            if gameProcessed then return end
            
            if input.KeyCode == Enum.KeyCode.Space then
                if hum.FloorMaterial ~= Enum.Material.Air then
                    -- On ground, allow double jump
                    canDoubleJump = true
                    hasDoubleJumped = false
                elseif canDoubleJump and not hasDoubleJumped then
                    -- In air and haven't double jumped yet
                    hasDoubleJumped = true
                    canDoubleJump = false
                    
                    -- Apply double jump force
                    local currentVelocity = root.Velocity
                    root.Velocity = Vector3.new(currentVelocity.X, hum.JumpPower * 1.3, currentVelocity.Z)
                end
            end
        end)
        
        local connection2 = runs.Heartbeat:Connect(function()
            if hum.FloorMaterial ~= Enum.Material.Air then
                -- Reset when on ground
                hasDoubleJumped = false
                canDoubleJump = true
            end
        end)
        
        table.insert(doubleJumpConnections, connection1)
        table.insert(doubleJumpConnections, connection2)
    end
end

-- ESP functions
function createPlayerESP(targetPlr)
    local bgui = Instance.new("BillboardGui", game.CoreGui)
    bgui.Name = targetPlr.Name .. "_NevoxESP"
    bgui.Size = UDim2.new(0, 250, 0, 100)
    bgui.AlwaysOnTop = true
    bgui.ExtentsOffset = Vector3.new(0, 3.5, 0)
    
    local container = Instance.new("Frame", bgui)
    container.Size = UDim2.new(1, 0, 1, 0)
    container.BackgroundTransparency = 1

    local function createLabel(size, pos, fontSize)
        local lbl = Instance.new("TextLabel", container)
        lbl.Size = size
        lbl.Position = pos
        lbl.BackgroundTransparency = 1
        lbl.Font = Enum.Font.GothamBold
        lbl.TextSize = fontSize
        lbl.TextStrokeTransparency = 0
        lbl.TextStrokeColor3 = Color3.new(0, 0, 0)
        return lbl
    end

    local nameLabel = createLabel(UDim2.new(1, 0, 0, 22), UDim2.new(0, 0, 0, 0), 18)
    local infoLabel = createLabel(UDim2.new(1, 0, 0, 18), UDim2.new(0, 0, 0, 22), 14)

    runs.RenderStepped:Connect(function()
        local tChar = workspace.Players:FindFirstChild(targetPlr.Name)
        if not espEnabled or not tChar or not tChar:FindFirstChild("HumanoidRootPart") then
            nameLabel.Visible = false
            infoLabel.Visible = false
            return
        end
        local distance = (tChar.HumanoidRootPart.Position - root.Position).Magnitude
        if distance > espMaxDistance then
            nameLabel.Visible = false
            infoLabel.Visible = false
            return
        end

        bgui.Adornee = tChar.HumanoidRootPart
        nameLabel.Visible = true
        infoLabel.Visible = true
        
        local tribeColor = targetPlr.TeamColor and targetPlr.TeamColor.Color or Color3.fromRGB(139, 69, 19)
        nameLabel.TextColor3 = tribeColor
        infoLabel.TextColor3 = tribeColor
        nameLabel.Text = targetPlr.Name .. " [" .. math.floor(distance) .. "m]"

        local details = {}
        if espShowHP and tChar:FindFirstChild("Humanoid") then
            table.insert(details, "HP: " .. math.floor(tChar.Humanoid.Health))
        end
        
        if espShowArmor then
            local armorFound = {}
            for _, v in pairs(tChar:GetChildren()) do
                if v.Name:lower():find("chest") or v.Name:lower():find("greaves") or v.Name:lower():find("helmet") or v.Name:lower():find("halo") or v.Name:lower():find("crown") then
                    local typeParts = stringSplit(v.Name, " ")
                    local type = typeParts[1] or v.Name
                    if not tableFind(armorFound, type) then
                        table.insert(armorFound, type)
                    end
                end
            end
            if #armorFound > 0 then
                table.insert(details, "A: " .. table.concat(armorFound, "/"))
            else
                table.insert(details, "A: None")
            end
        end
        
        if espShowWeapon then
            local tools = tChar:FindFirstChild("Tools")
            local hName = tools and (tools:FindFirstChildWhichIsA("Model") or tools:FindFirstChildWhichIsA("BasePart"))
            if hName then
                table.insert(details, "W: " .. hName.Name)
            else
                table.insert(details, "W: None")
            end
        end
        
        if #details > 0 then
            infoLabel.Text = table.concat(details, " â€¢ ")
        else
            infoLabel.Text = ""
        end
    end)
end

function createESPForAllPlayers()
    for _, p in pairs(game.Players:GetPlayers()) do
        if p ~= plr then
            createPlayerESP(p)
        end
    end
end

function clearESP()
    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= plr then
            local esp = game.CoreGui:FindFirstChild(player.Name .. "_NevoxESP")
            if esp then
                esp:Destroy()
            end
        end
    end
end

-- Farming functions
local function getPlantBoxes(range)
    local plantBoxes = {}
    for _, deployable in ipairs(workspace.Deployables:GetChildren()) do
        if deployable:IsA("Model") and deployable.Name == "Plant Box" then
            local entityId = deployable:GetAttribute("EntityID")
            local pPart = deployable.PrimaryPart or deployable:FindFirstChildWhichIsA("BasePart")
            if entityId and pPart then
                local dist = (pPart.Position - root.Position).Magnitude
                if dist <= range then
                    table.insert(plantBoxes, { entityId = entityId, deployable = deployable, dist = dist })
                end
            end
        end
    end
    return plantBoxes
end

local function getBushes(range, fruitName)
    local bushes = {}
    for _, model in ipairs(workspace:GetChildren()) do
        if model:IsA("Model") and model.Name:find(fruitName) then
            local pPart = model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart")
            if pPart then
                local dist = (pPart.Position - root.Position).Magnitude
                if dist <= range then
                    local entityId = model:GetAttribute("EntityID")
                    if entityId then
                        table.insert(bushes, { entityId = entityId, model = model, dist = dist })
                    end
                end
            end
        end
    end
    return bushes
end

-- FIXED Tween function - Slower like 18 walkspeed
local tweening = nil
local function tweenTo(targetCFrame)
    if tweening then 
        tweening:Cancel() 
        tweening = nil
    end
    
    local distance = (root.Position - targetCFrame.Position).Magnitude
    local duration = math.max(0.5, distance / 18)  -- Slower like 18 walkspeed
    
    local tweenInfo = TweenInfo.new(
        duration,
        Enum.EasingStyle.Linear,
        Enum.EasingDirection.Out
    )
    
    tweening = tspmo:Create(root, tweenInfo, {CFrame = targetCFrame})
    tweening:Play()
end

-- =================== MAIN LOOPS ===================
-- Auto Heal and Auto Eat - FIXED NaN issue
task.spawn(function()
    while true do
        local eatDelay = 1 / math.max(1, autoEatCPS)
        
        if autoHealEnabled then
            local health = getHealth()
            if health < autoHealThreshold and (tick() - lastEatTime) > eatDelay then
                local inventoryList = plr.PlayerGui.MainGui.RightPanel.Inventory:FindFirstChild("List")
                if inventoryList then
                    local item = inventoryList:FindFirstChild(autoHealFruit)
                    if item and item:IsA("ImageLabel") then
                        if packets and packets.UseBagItem and packets.UseBagItem.send then
                            packets.UseBagItem.send(item.LayoutOrder)
                            lastEatTime = tick()
                        end
                    end
                end
            end
        end
        
        if autoEatEnabled then
            local hunger = getHunger()
            if hunger < autoEatThreshold and (tick() - lastEatTime) > eatDelay then
                local inventoryList = plr.PlayerGui.MainGui.RightPanel.Inventory:FindFirstChild("List")
                if inventoryList then
                    local item = inventoryList:FindFirstChild(autoEatFruit)
                    if item and item:IsA("ImageLabel") then
                        if packets and packets.UseBagItem and packets.UseBagItem.send then
                            packets.UseBagItem.send(item.LayoutOrder)
                            lastEatTime = tick()
                        end
                    end
                end
            end
        end
        
        task.wait(0.05)
    end
end)

-- Kill Aura
task.spawn(function()
    while true do
        if killAuraEnabled then
            local targets = {}
            for _, player in pairs(game.Players:GetPlayers()) do
                if player ~= plr then
                    local playerFolder = workspace.Players:FindFirstChild(player.Name)
                    if playerFolder then
                        local rootPart = playerFolder:FindFirstChild("HumanoidRootPart")
                        local entityId = playerFolder:GetAttribute("EntityID")
                        if rootPart and entityId then
                            local dist = (rootPart.Position - root.Position).Magnitude
                            if dist <= killAuraRange then
                                table.insert(targets, { eid = entityId, dist = dist })
                            end
                        end
                    end
                end
            end

            if #targets > 0 then
                table.sort(targets, function(a, b) return a.dist < b.dist end)
                local selectedTargets = {}
                for i = 1, math.min(kaTargetCount, #targets) do
                    table.insert(selectedTargets, targets[i].eid)
                end
                swingTool(selectedTargets)
            end
        end
        task.wait(kaSwingCooldown)
    end
end)

-- Resource Aura
task.spawn(function()
    while true do
        if resourceAuraEnabled then
            local targets = {}
            local allResources = {}
            
            for _, r in pairs(workspace.Resources:GetChildren()) do
                table.insert(allResources, r)
            end
            for _, r in pairs(workspace:GetChildren()) do
                if r:IsA("Model") and r.Name == "Gold Node" then
                    table.insert(allResources, r)
                end
            end

            for _, res in pairs(allResources) do
                if res:IsA("Model") and res:GetAttribute("EntityID") then
                    local eid = res:GetAttribute("EntityID")
                    local pPart = res.PrimaryPart or res:FindFirstChildWhichIsA("BasePart")
                    if pPart then
                        local dist = (pPart.Position - root.Position).Magnitude
                        if dist <= resourceAuraRange then
                            table.insert(targets, { eid = eid, dist = dist })
                        end
                    end
                end
            end

            if #targets > 0 then
                table.sort(targets, function(a, b) return a.dist < b.dist end)
                local selectedTargets = {}
                for i = 1, math.min(resourceTargetCount, #targets) do
                    table.insert(selectedTargets, targets[i].eid)
                end
                swingTool(selectedTargets)
            end
        end
        task.wait(resourceCooldown)
    end
end)

-- Critter Aura
task.spawn(function()
    while true do
        if critterAuraEnabled then
            local targets = {}
            for _, critter in pairs(workspace.Critters:GetChildren()) do
                if critter:IsA("Model") and critter:GetAttribute("EntityID") then
                    local eid = critter:GetAttribute("EntityID")
                    local pPart = critter.PrimaryPart or critter:FindFirstChildWhichIsA("BasePart")
                    if pPart then
                        local dist = (pPart.Position - root.Position).Magnitude
                        if dist <= critterRange then
                            table.insert(targets, { eid = eid, dist = dist })
                        end
                    end
                end
            end

            if #targets > 0 then
                table.sort(targets, function(a, b) return a.dist < b.dist end)
                local selectedTargets = {}
                for i = 1, math.min(critterTargetCount, #targets) do
                    table.insert(selectedTargets, targets[i].eid)
                end
                swingTool(selectedTargets)
            end
        end
        task.wait(critterCooldown)
    end
end)

-- FIXED Auto Pickup - Now works with dropdown
task.spawn(function()
    while true do
        if autoPickupEnabled then
            for _, item in ipairs(workspace.Items:GetChildren()) do
                if item:IsA("BasePart") or item:IsA("MeshPart") then
                    local itemName = item.Name
                    local entityId = item:GetAttribute("EntityID")
                    
                    local shouldPickup = false
                    
                    if customPickupEnabled and customPickupText ~= "" then
                        -- Custom pickup mode
                        if string.find(string.lower(itemName), string.lower(customPickupText)) then
                            shouldPickup = true
                        end
                    else
                        -- Normal dropdown mode
                        if tableFind(selectedItems, itemName) then
                            shouldPickup = true
                        end
                    end
                    
                    if shouldPickup and entityId then
                        local dist = (item.Position - root.Position).Magnitude
                        if dist <= pickupRange then
                            pickup(entityId)
                        end
                    end
                end
            end
        end

        if chestPickupEnabled then
            for _, chest in ipairs(workspace.Deployables:GetChildren()) do
                if chest:IsA("Model") and chest:FindFirstChild("Contents") then
                    for _, item in ipairs(chest.Contents:GetChildren()) do
                        if item:IsA("BasePart") or item:IsA("MeshPart") then
                            local itemName = item.Name
                            local entityId = item:GetAttribute("EntityID")
                            
                            local shouldPickup = false
                            if customPickupEnabled and customPickupText ~= "" then
                                if string.find(string.lower(itemName), string.lower(customPickupText)) then
                                    shouldPickup = true
                                end
                            else
                                if tableFind(selectedItems, itemName) then
                                    shouldPickup = true
                                end
                            end
                            
                            if shouldPickup and entityId then
                                local dist = (chest.PrimaryPart.Position - root.Position).Magnitude
                                if dist <= pickupRange then
                                    pickup(entityId)
                                end
                            end
                        end
                    end
                end
            end
        end
        task.wait(0.01)
    end
end)

-- FIXED Auto Drop - Much faster
task.spawn(function()
    while true do
        if autoDropEnabled then
            if dropItem == "All" then
                -- Drop all items in the dropdown list VERY FAST
                for _, itemName in ipairs(allDropItems) do
                    drop(itemName)
                    task.wait(0.001) -- Very small delay for speed
                end
            else
                drop(dropItem)
            end
        end
        if autoDropCustomEnabled then
            drop(customDropItem)
        end
        task.wait(0.01) -- Much faster loop
    end
end)

-- Auto Plant
task.spawn(function()
    while true do
        if plantToggle then
            local plantBoxes = getPlantBoxes(plantRange)
            table.sort(plantBoxes, function(a, b) return a.dist < b.dist end)
            local itemId = fruitToItemId[selectedFruit] or 94
            
            for _, box in ipairs(plantBoxes) do
                if not box.deployable:FindFirstChild("Seed") then
                    plant(box.entityId, itemId)
                    task.wait(plantDelay)
                end
            end
        end
        task.wait(0.1)
    end
end)

-- Auto Harvest
task.spawn(function()
    while true do
        if harvestToggle then
            local bushes = getBushes(harvestRange, selectedFruit)
            table.sort(bushes, function(a, b) return a.dist < b.dist end)
            for _, bush in ipairs(bushes) do
                pickup(bush.entityId)
            end
        end
        task.wait(0.1)
    end
end)

-- Tween to Plant Box
task.spawn(function()
    while true do
        if tweenToPlantBox then
            local plantBoxes = getPlantBoxes(tweenRange)
            table.sort(plantBoxes, function(a, b) return a.dist < b.dist end)
            
            for _, box in ipairs(plantBoxes) do
                if not box.deployable:FindFirstChild("Seed") then
                    local target = box.deployable.PrimaryPart.CFrame + Vector3.new(0, 3, 0)
                    tweenTo(target)
                    break
                end
            end
        end
        task.wait(0.2)
    end
end)

-- Tween to Bush + Plant Box
task.spawn(function()
    while true do
        if tweenToBush then
            local bushes = getBushes(tweenRange, selectedFruit)
            table.sort(bushes, function(a, b) return a.dist < b.dist end)
            
            if #bushes > 0 then
                for _, bush in ipairs(bushes) do
                    local target = bush.model.PrimaryPart.CFrame + Vector3.new(0, 3, 0)
                    tweenTo(target)
                    break
                end
            else
                local plantBoxes = getPlantBoxes(tweenRange)
                table.sort(plantBoxes, function(a, b) return a.dist < b.dist end)
                for _, box in ipairs(plantBoxes) do
                    if not box.deployable:FindFirstChild("Seed") then
                        local target = box.deployable.PrimaryPart.CFrame + Vector3.new(0, 3, 0)
                        tweenTo(target)
                        break
                    end
                end
            end
        end
        task.wait(0.2)
    end
end)

-- Character reset handler
plr.CharacterAdded:Connect(function(newChar)
    char = newChar
    root = char:WaitForChild("HumanoidRootPart")
    hum = char:WaitForChild("Humanoid")
    
    originalValues = {
        WalkSpeed = hum.WalkSpeed,
        JumpPower = hum.JumpPower,
        HipHeight = hum.HipHeight,
        MaxSlopeAngle = hum.MaxSlopeAngle
    }
    
    canDoubleJump = false
    hasDoubleJumped = false
    
    if wstoggle:Get() then updateWalkspeed(true) end
    if jptoggle:Get() then updateJumpPower(true) end
    if hheighttoggle:Get() then updateHipHeight(true) end
    if msatoggle:Get() then updateNoSlip(true) end
    if doublejumptoggle:Get() then updateDoubleJump(true) end
end)

-- Initialize ESP for existing players
createESPForAllPlayers()

-- Setup ESP for new players
game.Players.PlayerAdded:Connect(function(player)
    if player ~= plr then
        createPlayerESP(player)
    end
end)

-- Clean up ESP when player leaves
game.Players.PlayerRemoving:Connect(function(player)
    local esp = game.CoreGui:FindFirstChild(player.Name .. "_NevoxESP")
    if esp then
        esp:Destroy()
    end
end)

Library:Notification({
    Title = "Nevox BBR Loaded",
    Description = "All features loaded successfully!",
    Duration = 5,
    Icon = "73789337996373"
})

Window:Init()
getgenv().Library = Library
